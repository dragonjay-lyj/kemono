---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import { PostDetail } from '../../components/PostDetail';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map(post => ({
    params: { slug: post.slug.replace('.mdx', '') },
    props: { post },
  }));
}

const { post } = Astro.props;
const authors = await getCollection('authors');
const author = authors.find(a => 
  a.id.replace('.mdx', '') === post.data.authorId.replace('.mdx', '')
);

if (!author) {
  return Astro.redirect('/404');
}

const allPosts = await getCollection('posts');
const currentIndex = allPosts.findIndex(p => p.slug === post.slug);
const prevPost = currentIndex > 0 ? allPosts[currentIndex - 1] : null;
const nextPost = currentIndex < allPosts.length - 1 ? allPosts[currentIndex + 1] : null;

export const prerender = true
---

<Layout title={post.data.title}>
  <PostDetail
    client:load
    post={post}
    author={author}
    prevPost={prevPost}
    nextPost={nextPost}
  />
</Layout>
